{% extends "base.html" %}
{% load static %}

{% block title %}Games - LRG Network{% endblock %}

{% block extra_css %}
{% if view_mode == 'map' %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
<link rel="stylesheet" href="{% static 'games/css/game_map.css' %}">
{% endif %}
{% endblock %}

{% block content %}
<div class="container-xl py-3">
<div class="row mb-4">
    <div class="col-12 text-center">
      <h1 class="mb-2">Games</h1>
      <nav class="games-view-toggle" role="navigation" aria-label="View as list or map">
        <a id="games-view-list-link" href="{{ list_view_url }}" class="games-view-toggle-link {% if view_mode == 'list' %}active{% endif %}">List</a>
        <span class="games-view-toggle-sep" aria-hidden="true">|</span>
        <a id="games-view-map-link" href="{{ map_view_url }}" class="games-view-toggle-link {% if view_mode == 'map' %}active{% endif %}">Map</a>
      </nav>
    </div>
</div>

<div class="container-md mx-auto mb-4">
<form id="game-filter-form" method="get">
<input type="hidden" name="view" value="{{ view_mode }}">
    <input type="hidden" name="filter_open" id="filterOpenInput" value="{{ request.GET.filter_open|default_if_none:'' }}">
    <div class="games-search-row d-flex flex-wrap align-items-center gap-3">
        <div class="input-group games-search-group">
            <input
                type="text"
                name="q"
                id="searchInput"
                class="form-control"
                placeholder="Search games..."
                value="{{ request.GET.q }}"
            />
            <button type="submit" class="btn btn-primary games-search-btn btn-hover-scale" aria-label="Search games">Search</button>
        </div>
        <button type="button" id="toggleFiltersBtn" class="btn btn-success games-filter-btn btn-hover-scale" aria-label="Toggle filters">
            Filter <span id="filterCountBadge" class="badge games-filter-badge ms-1 hidden" aria-hidden="true"></span>
        </button>
    </div>

    <div id="filtersContainer" class="hidden">
        <div class="row g-3 align-items-end mt-0">
            <div class="col-md-4">
                <label for="country" class="form-label d-block">Country</label>
                <select id="country" name="country" class="selectpicker w-100" data-live-search="true">
                    <option value="">All</option>
                    {% for country in countries %}
                        <option value="{{ country.id }}" {% if country.id|stringformat:"s" == selected_country %}selected{% endif %}>{{ country.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="region" class="form-label d-block">State/Region</label>
                <select id="region" name="region" class="selectpicker w-100" data-live-search="true" data-size="10" {% if not selected_country %}disabled{% endif %}>
                    <option value="">All</option>
                    {% for region in regions %}
                        {% if region.id in regions_with_games %}
                            <option value="{{ region.id }}" {% if region.id|stringformat:"s" == selected_region %}selected{% endif %}>{{ region.name }}</option>
                        {% else %}
                            <option value="{{ region.id }}" disabled>{{ region.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="city" class="form-label d-block">City</label>
                <select id="city" name="city" class="selectpicker w-100" data-live-search="true" data-size="10" {% if not selected_region %}disabled{% endif %} onchange="submitFormWithNonEmptyParams()">
                    <option value="">All</option>
                    {% for city in cities %}
                        <option value="{{ city.id }}" {% if city.id|stringformat:"s" == selected_city %}selected{% endif %}>{{ city.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="row g-3 align-items-end mt-0">
            <div class="col-md-4">
                <label for="game_format" class="form-label d-block">Format</label>
                <select id="game_format" name="game_format" multiple class="selectpicker w-100" data-actions-box="true" data-size="8">
                    {% for format in game_formats %}
                        <option value="{{ format.0 }}" {% if format.0 in selected_game_formats %}selected{% endif %}>{{ format.1 }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4">
                <label for="game_duration" class="form-label d-block">Duration</label>
                <select id="game_duration" name="game_duration" multiple class="selectpicker w-100" data-actions-box="true" data-size="8">
                    {% for duration in game_durations %}
                        <option value="{{ duration.0 }}" {% if duration.0 in selected_game_durations %}selected{% endif %}>{{ duration.1 }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4">
                <label for="filming_status" class="form-label d-block">Viewing Format</label>
                <select id="filming_status" name="filming_status" multiple class="selectpicker w-100" data-actions-box="true" data-size="8">
                    {% for status in filming_statuses %}
                        <option value="{{ status.0 }}" {% if status.0 in selected_filming_statuses %}selected{% endif %}>{{ status.1 }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="row g-3 align-items-end mt-0">
            <div class="col-md-4">
                <label for="inactive_filter" class="form-label">Inactive</label>
                <select id="inactive_filter" name="inactive_filter" class="selectpicker w-100" onchange="submitFormWithNonEmptyParams()">
                    <option value="" {% if not inactive_filter %}selected{% endif %}>Include</option>
                    <option value="exclude" {% if inactive_filter == 'exclude' %}selected{% endif %}>Don't show</option>
                    <option value="only" {% if inactive_filter == 'only' %}selected{% endif %}>Only show</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="college_filter" class="form-label">College Students Only</label>
                <select id="college_filter" name="college_filter" class="selectpicker w-100" onchange="submitFormWithNonEmptyParams()">
                    <option value="" {% if not college_filter %}selected{% endif %}>Include</option>
                    <option value="exclude" {% if college_filter == 'exclude' %}selected{% endif %}>Don't show</option>
                    <option value="only" {% if college_filter == 'only' %}selected{% endif %}>Only show</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="friends_and_family_filter" class="form-label">Friends & Family Only</label>
                <select id="friends_and_family_filter" name="friends_and_family_filter" class="selectpicker w-100{% if friends_and_family_filter %} selected{% endif %}" onchange="submitFormWithNonEmptyParams()">
                    <option value="" {% if not friends_and_family_filter %}selected{% endif %}>Include</option>
                    <option value="exclude" {% if friends_and_family_filter == 'exclude' %}selected{% endif %}>Don't show</option>
                    <option value="only" {% if friends_and_family_filter == 'only' %}selected{% endif %}>Only show</option>
                </select>
            </div>
        </div>
        <div class="row g-3 align-items-end mt-0 justify-content-center">
            <div class="col-md-4">
                <label for="charity_filter" class="form-label">For Charity</label>
                <select id="charity_filter" name="charity_filter" class="selectpicker w-100{% if charity_filter %} selected{% endif %}" onchange="submitFormWithNonEmptyParams()">
                    <option value="" {% if not charity_filter %}selected{% endif %}>Include</option>
                    <option value="exclude" {% if charity_filter == 'exclude' %}selected{% endif %}>Don't show</option>
                    <option value="only" {% if charity_filter == 'only' %}selected{% endif %}>Only show</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="casting_filter" class="form-label">Active Casting</label>
                <select id="casting_filter" name="casting_filter" class="selectpicker w-100{% if casting_filter %} selected{% endif %}" onchange="submitFormWithNonEmptyParams()">
                    <option value="" {% if not casting_filter %}selected{% endif %}>Include</option>
                    <option value="exclude" {% if casting_filter == 'exclude' %}selected{% endif %}>Don't show</option>
                    <option value="only" {% if casting_filter == 'only' %}selected{% endif %}>Only show</option>
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button type="button" class="btn btn-danger w-100 btn-hover-scale" id="resetBtn" aria-label="Reset all filters">Reset</button>
            </div>
        </div>
    </div>
</form>
</div>

<div class="container-xl">
{% include "games/partials/game_list.html" %}
</div>
</div>

{% include "games/partials/game_map.html" %}

<script src="{% static 'games/js/game_list.js' %}"></script>
{% endblock %}
